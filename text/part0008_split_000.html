<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>未知</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">addl</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">$64,</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">%ecx</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">cmpl</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">$16,</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">%edx</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">jne</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">.L6</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">Add 64 to Bptr Compare j:16</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">If /:,</span>
</b>
</i>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">goto loop</span>
</b>
</i>
</span>
</p>
<p class="calibre9" style="margin:0pt; border:0pt; height:1em"> </p>
<p class="calibre9" style="margin:0pt; border:0pt; height:1em"> </p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">正如看到的那样，在循环中，寄存器％ecx是被增加64 (第6行)。机器代码认为每个指针 都指向的一个字节地址，因此在编译指针运算中，每次都应该增加底层数据类型的大小。</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">®练习题3.38下面的C代码将定长数组的对角线上的元素设置为val:‘</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre2">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">/*</span>
</b>
</i>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">Set all diagonal elements to val</span>
</b>
</span>
 <span class="calibre2">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">*/</span>
</b>
</i>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">void fix_set_diag(fix_matrix</span>
</b>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">A,</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">int val) {</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">int i;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">for (i</span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">= 0;</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">i 〈拉；i++)</span>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">A[i] [i] = val;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">&gt;</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">当编译时，GCC产生如下汇编代码</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">.4</span>
</b>
</i>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">at %ebp-f-8, val at %ebp+12</span>
</b>
</i>
</span>
</p>
<table valign="top" class="calibre19">
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">1</span>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">movl</span>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">8(%ebp), %ecx</span>
</tt>
</span>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">2</span>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">movl</span>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">12(%ebp), %edx</span>
</tt>
</span>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">3</span>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">movl</span>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">$0, %eax</span>
</tt>
</span>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">4</span>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">.L14:</span>
</b>
</tt>
</span>
</p>
</td>
<td class="calibre21"><br class="calibre9"/>
<br class="calibre9"/>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">5</span>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">movl</span>
</b>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">%edx, (%ecx,7<sub class="calibre24">
<small class="calibre8">
<span class="calibre18">
<tt class="calibre3">
<span class="calibre4">0</span>
</tt>
</span>
</small>
</sub>
 ec</span>
</tt>
</span>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">6</span>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">addl</span>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">$68, %eax</span>
</tt>
</span>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">7</span>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">cmpl</span>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">$1088, °/<sub class="calibre24">
<small class="calibre8">
<span class="calibre18">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">0</span>
</b>
</tt>
</span>
</small>
</sub>
 eax</span>
</b>
</tt>
</span>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">8</span>
</b>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">jne</span>
</b>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">.L14</span>
</b>
</tt>
</span>
</p>
</td>
</tr>
</table>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">创建一个c代码程序fix-set-diag-opt,参考这段汇编代码中所使用的优化,风格与图3-28b中的代码- 致。使用含有参数W的表达式，而不是整数常量，使得如果重新定义了 M你的代码仍能够正确地工作。</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">int i, int’k) {</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre2">
<tt class="calibre3">
<span class="calibre4">1</span>
</tt>
</span>
 <span class="calibre2">
<b class="calibre13">
<span class="calibre4">2</span>
</b>
</span>
 <tt class="calibre3">
<i class="calibre15">
<span class="calibre4">3</span>
</i>
</tt>
 <tt class="calibre3">
<span class="calibre4">.4</span>
</tt>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">‘5 6</span>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">7</span>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">9</span>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre2">
<tt class="calibre3">
<span class="calibre4">10</span>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<b class="calibre13">
<span class="calibre4">/* Compute i,k of fixed matrix product */</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">int fix_prod_ele (fix_matrix A, fix_matrix B,</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<i class="calibre15">
<span class="calibre4">!</span>
</i>
</tt>
 <tt class="calibre3">
<span class="calibre4">int</span>
</tt>
 <tt class="calibre3">
<span class="calibre4">      </span>
</tt>
 <tt class="calibre3">
<span class="calibre4">-</span>
</tt>
 <tt class="calibre3">
<span class="calibre4">      </span>
</tt>
 <tt class="calibre3">
<span class="calibre4">,</span>
</tt>
 <tt class="calibre3">
<span class="calibre4">      </span>
</tt>
 <tt class="calibre3">
<i class="calibre15">
<span class="calibre4">.:</span>
</i>
</tt>
 <tt class="calibre3">
<span class="calibre4">      </span>
</tt>
 <tt class="calibre3">
<span class="calibre4">,</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">int result = 0;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">for (j = 0; j</span>
</b>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">&lt; K;</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">j++)</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">result += A[i] [j] * B[j] [k];</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">return result;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<b class="calibre13">
<span class="calibre4">a)</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">原始的</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">C</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">代码</span>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">./*</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">Compute i,k of fixed matrix product */</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">int fix_prod_ele_opt(fix_matrix A, fixjnatrix B, int i, int k) {</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">int</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">*Arow</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">=</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">&amp;A[i] [0];</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">int</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">*Bptr</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">=</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">&amp;B[0] [k];.</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">int</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">result = 0;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<b class="calibre13">
<span class="calibre4">int</span>
</b>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">j;</span>
</b>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">for (j = 0; j != N; j++) {</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">result += Arow[j] * *Bptr;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">Bptr += N;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">}</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">return result;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">&gt; 一 .</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<b class="calibre13">
<span class="calibre4">b)</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">优化过的</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">C</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">代码</span>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">图3-28原代码的和优化过的代码，该代码计算定择数#的矩阵乘积的元素U。编译器会自动完成这些优化</span>
</b>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<a href="http://www.TopSage.com">
<span class="calibre12">
<b class="calibre13">
<span class="calibre16">
<span class="calibre14">www.TopSage.com</span>
</span>
</b>
</span>
</a>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">3.8:5变长数組</span>
</b>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">历史</span>
</tt>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">iE,</span>
</b>
</span>
 <tt class="calibre3">
<span class="calibre4">C语言只支持在编译时就能确定大小的多维数组(对于第一维可能有些例外h程 序员需要变长数组时，不得不用malloc或calloc这样的函数为这些数组分配存储空间，而 且不得不显式地编码，用行优先索弓丨将多维数组映射到一维的数组，如公式（3-1.)所示。ISO 099引人了一种能力,允许数组的维度是表达式，在数组被分配的时候才计算出来,并且最近的 GCG版本支持ISO C99中关于变长数组的大部分规则。:</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">在变长数组的C販本中,我们将一个数组声明为int . .Ale<sub class="calibre17">
<small class="calibre8">
<tt class="calibre3">
<span class="calibre4">X</span>
</tt>
</small>
</sub>
 ^r</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">2<sub class="calibre29">
<small class="calibre8">
<tt class="calibre3">
<span class="calibre4">] [exp</span>
</tt>
</small>
</sub>
</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">r</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">2</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">],它可以作为一 个局部变量,也可以作一个函数的参数，.然后在遇到这个声明的时候,囉过对表达式ex<sub class="calibre17">
<small class="calibre8">
<tt class="calibre3">
<span class="calibre4">P</span>
</tt>
</small>
</sub>
 r</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">2</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">和 expr</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">2</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">求值来确定数组的维度。因此，例如要访问数组的元素/，》我们可以写一个如下 的函数：</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">int var_ele(int n, int A[n] [n] , int i, int j) ■[</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">return A [i] [j ];</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">参数n必须在参数A [n] [n]之前，这样函数就可以在遇到这个数组的时候计算出数组的 维度。</span>
</tt>
 <tt class="calibre3">
<span class="calibre4">      </span>
</tt>
 <tt class="calibre3">
<span class="calibre4">...</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">GCC为这个引用函数产生的代码如下所示：</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre2">
<tt class="calibre3">
<span class="calibre4">..</span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">.：</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">• -</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">n</span>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">at</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">%ebp-rS<sub class="calibre24">
<small class="calibre8">
<span class="calibre18">
<tt class="calibre3">
<span class="calibre4">&gt;</span>
</tt>
</span>
</small>
</sub>
</span>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">A at y<sub class="calibre24">
<small class="calibre8">
<span class="calibre18">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">o</span>
</b>
</i>
</span>
</small>
</sub>
 e'bp+12, i at</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">%ebp+i.6',</span>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">j</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">at %ebp+20</span>
</tt>
</span>
</p>
<table valign="top" class="calibre19">
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">1</span>
</tt>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">movl</span>
</tt>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">8&lt;%ebp), %eax -</span>
</tt>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">■</span>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">Get</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<i class="calibre15">
<span class="calibre4">n</span>
</i>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">2</span>
</tt>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<i class="calibre15">
<span class="calibre4">:</span>
</i>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">sail::</span>
</tt>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">$2, %eax</span>
</tt>
 <span class="calibre12">
<tt class="calibre3">
<i class="calibre15">
<span class="calibre4">:..</span>
</i>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre2">
<tt class="calibre3">
<i class="calibre15">
<span class="calibre4">L</span>
</i>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<i class="calibre15">
<span class="calibre4">Compxite 4.*n</span>
</i>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">' .. '</span>
</tt>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">3</span>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">movl</span>
</tt>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">°/<sub class="calibre17">
<small class="calibre8">
<tt class="calibre3">
<span class="calibre4">0</span>
</tt>
</small>
</sub>
 eax, %edx</span>
</tt>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">Copy 4*n</span>
</b>
</i>
</span>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">4</span>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">imull</span>
</tt>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">16(%ebp), %edx</span>
</tt>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">Compute 4*n*i</span>
</b>
</i>
</span>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">5</span>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">movl</span>
</tt>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">20(%ebp), %eax</span>
</tt>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">Get j</span>
</b>
</i>
</span>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">6</span>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">sail</span>
</tt>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">$2, %eax .,</span>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">Compute 4*j</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">.</span>
</tt>
</span>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">7</span>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">addl""</span>
</tt>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">12(<sup class="calibre7">
<small class="calibre8">
<tt class="calibre3">
<span class="calibre4">0</span>
</tt>
</small>
</sup>
 /<sub class="calibre17">
<small class="calibre8">
<tt class="calibre3">
<span class="calibre4">0</span>
</tt>
</small>
</sub>
 ebp) , %eax</span>
</tt>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">Compute</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">+</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">4</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">沐</span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<i class="calibre15">
<span class="calibre4">j</span>
</i>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">‘</span>
</tt>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">8</span>
</tt>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">.movl</span>
</tt>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">(%eax, %'edx), %eax</span>
</tt>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">'</span>
</tt>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">Read from</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">.</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">,v<sub class="calibre17">
<small class="calibre8">
<tt class="calibre3">
<span class="calibre4">A</span>
</tt>
</small>
</sub>
</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">十</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">4_ *</span>
</tt>
</p>
</td>
</tr>
</table>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre2">
<tt class="calibre3">
<span class="calibre4">0</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">/ + r + y)</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre28">
<tt class="calibre3">
<span class="calibre4">正如注释所示，这段代码计算元素/,</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">7</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">的地址为x<sub class="calibre17">
<small class="calibre8">
<tt class="calibre3">
<span class="calibre4">a</span>
</tt>
</small>
</sub>
 +4(wH；/)。这个计算类似于定长数组的地址 计算，不同点最<sup class="calibre7">
<small class="calibre8">
<span class="calibre30">
<tt class="calibre3">
<span class="calibre4">4</span>
</tt>
</span>
</small>
</sup>
 )由于加上J参数参数在栈上的地址移动了 r</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">2</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">)用了乘法指令计算《 •</span>
</tt>
 <tt class="calibre3">
<i class="calibre15">
<span class="calibre4">i</span>
</i>
</tt>
 <tt class="calibre3">
<span class="calibre4">(第4行),而不晕用leal指令计算队因此引用变长数组只需要对定长数组做一点几概括。动 态的脲本必须用乘抟指令对/伸展/r倍,而不_用了系列的移位和加法。在一些处理器中,乘法 会招致严重的性能处罚,但是在这种情况下不可避免。</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">：</span>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre28">
<tt class="calibre3">
<span class="calibre4">在一个循环中引用变长数组时，编译器常常可以利用访问模式的规律性来优化索弓丨的计箅。 例如，图3-<sup class="calibre7">
<small class="calibre8">
<span class="calibre30">
<tt class="calibre3">
<span class="calibre4">2</span>
</tt>
</span>
</small>
</sup>
 9给出的C代码，它计算两个矩阵A和厚乘积的元素/，*。编译器产生的代码 类似于定长爽駔的代码。实际上，这个代码与图3-28b的择海if类似,除了每次循环中，它对 Bptr <sup class="calibre7">
<small class="calibre8">
<tt class="calibre3">
<span class="calibre4">(</span>
</tt>
</small>
</sup>
 指向元素B[j] [k]的榫针；)伸缩变量值^而不晕崗定每值尽</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre28">
<tt class="calibre3">
<span class="calibre4">下面是var prod ele循杯的汇编代码</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">：</span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">^</span>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">一 一 . • '* - . ■-.*</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre28">
<span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">n stored at</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">%ebp+^</span>
</b>
</i>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre28">
<span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">Registers: Arov in</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">%esi</span>
</b>
</i>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">，</span>
</b>
</i>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">Bptr in</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">%ecx,</span>
</b>
</i>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">j in</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">%edx,</span>
</b>
</i>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</i>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">'</span>
</b>
</i>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">.result in</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">%ebx, %edi</span>
</b>
</i>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">holds 4*n</span>
</b>
</i>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">loop:</span>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">Get *Bptr</span>
</b>
</i>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">Multiply by Arow[j] Add to result Increment j</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">Add 4</span>
</b>
</i>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">木</span>
</b>
</i>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">ii to Bptr</span>
</b>
</i>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">Compare n:j If &gt;, goto</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">loop</span>
</b>
</i>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">.L30:</span>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">movl</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">(%ecx), %eax</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">imull</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">(%esi,%6dx,4), %eax</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">addl</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">%eax, %ebx</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">addl</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">$1, %edx</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">addl</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">%edi,</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">%ecx</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">cmpi</span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">%edx,</span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">8(%ebp&gt;)</span>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">jg</span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">.L30</span>
</tt>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">我们看到程序既使用了伸缩过的值4« (寄存器％60^)来增加Bptr,也使用了存储在相对 于％ebp偏移量为</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">8</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">处的</span>
</tt>
 <tt class="calibre3">
<i class="calibre15">
<span class="calibre4">n</span>
</i>
</tt>
 <tt class="calibre3">
<span class="calibre4">的实际值来检查循环的边界。C代码中并没有体现出需要这两个值, 但是由于指针运算的伸缩，才使用了这两个值。每次循环中，代码从存储器中取出《的值检査 循环是否终止（第7行)。这是二个寄存器溢出(register spilling)的例子：没有足够多的寄存器 来保存需要的临时数据，因此编译器必须把，些局部变量放在存储器中。在这个情况下编译器 选择把w溢出，因为它是一个“只读”的值——在循环中不会改变它的值。因为IA32处理器的 寄存器数量太少，必须常常将循环值溢出到存储器中。通常，读存储器完成起来比写存储器要容 易得多,因此将只读变量溢出是比较合适的。关于如何改进这段代码以避免寄存器溢出，请参见 家庭作业3.61。</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<i class="calibre15">
<span class="calibre4">/*</span>
</i>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">Compute i,k of variable matrix product */</span>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">int var_prod_ele(int n, int A[n][n], int B[n][n], int i, int k) {</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">int</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">j;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">int</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">result = 0;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">•</span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">..</span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">...</span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">.,.,</span>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">for</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">(j</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">= 0; j &lt; n; j++)</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">result += A[i] [j] * B[j] [k];</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre2">
<b class="calibre13">
<span class="calibre4">8</span>
</b>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">return</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">result;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">&gt;</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">图3-29计算变长数组的矩阵乘积的元素</span>
</tt>
 <tt class="calibre3">
<i class="calibre15">
<span class="calibre4">i，k<sub class="calibre17">
<small class="calibre8">
<tt class="calibre3">
<span class="calibre4">0</span>
</tt>
</small>
</sub>
</span>
</i>
</tt>
 <tt class="calibre3">
<span class="calibre4">编译器执行的优化类似于对定长数组的优化</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre11">
<span class="calibre4">3.9</span>
</span>
 <span class="calibre11">
<tt class="calibre3">
<span class="calibre4">异质的数据结构</span>
</tt>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">C语言提供了两种结合不同类型的对象来创建数据类型的机制：结构(structure),用关键字 struct声明，将多个对象集合到一个单位中；联合（union),用关键字union声明，允许用 几种不同的类型来引用一个对象。</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">3.9.1结构</span>
</b>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">C语言的struct声明创建一个数据类型，将可能不同类型的对象聚合到一个对象中。结构 的各个组成部分用名字来引用。类似于数组的实现，结构的所有组成部分都存放在存储器中一段 连续的区域内，而指向结构的指针就是结构第一个字节的地址。编译器维护关于每个结构类型的 信息，指示每个字段（field)的字节偏移。它以这些偏移作为存储器引用指令中的位移，从而产 生对结构元素的引用。</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">给C语言初学者：将一个对象表示为struct</span>
</b>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">C语言提供的struct数据类型的构造态数（constructor)与C++和Java的对象最为接近。 它允许程序员在一个数据结构中保存关于某个实体的信息，并用名字来引用这些信息。</span>
</tt>
</p>
<p height="0pt" width="-18pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">struct rect { int llx; int lly; int color; int width;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">例如，一个图形程序可能要用结构来表示一个长方形：</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">/* X coordinate of lower-left corner */</span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<i class="calibre15">
<span class="calibre4">/*</span>
</i>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">Y coordinate of lower-left corner */</span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<i class="calibre15">
<span class="calibre4">/*</span>
</i>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">Coding of color</span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">*/</span>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">/* Width (in pixels)</span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">*/</span>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">int height</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">; /* Height (in pixels)</span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">*/</span>
</tt>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">}；</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">可以声明一个struct rect类型的变量r,并设置它的字段值如下：：</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">struct rect r; r.llx = r.lly = 0; r.color = OxFFOOFF; r.width = 10; r.height = 20;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre2">
<tt class="calibre3">
<span class="calibre4">•. .</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">'</span>
</b>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">....</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">.</span>
</b>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">这里表达式</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">r</span>
</b>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">•</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">llx</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">就会选择结构</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">r</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">的</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">llx</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">字段。</span>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">另外，我们可以既声明变量又初始化它的字段在一条语句中：</span>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">struct rect r = { 0, 0， OxFFOOFF</span>
</b>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">,</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">10, 20 &gt;;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<b class="calibre13">
<span class="calibre4">.</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">一个常见的现象是，将指向结构的指针从一个地方传递到另一个地方，而不是复制它们<sub class="calibre24">
<small class="calibre8">
<span class="calibre18">
<tt class="calibre3">
<span class="calibre4">&amp;</span>
</tt>
</span>
</small>
</sub>
 例 如，下面的函数计算长方形的面积，这里，传递给函数的就是一个指向长方形</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">struct</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">的指针</span>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">int area(struct rect *rp)</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">. .- ,. ■ •.</span>
</tt>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<span class="calibre2">
<tt class="calibre3">
<i class="calibre15">
<span class="calibre4">\</span>
</i>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">return (*rp).width * (*rp).height;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<span class="calibre12">
<b class="calibre13">
<span class="calibre4">&gt;</span>
</b>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">表达式（</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">*rp) .width</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">间接引用了这个指针，并且选取所得结构的</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">width</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">字段。这里必须要 用括号，因为编译器会将表达式</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">*rp.width</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">解释为</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">* (rp.width),</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">而这是非法的。这种 间接引用和字段选取的结合使用非常常见，以至于</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">C</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">语言提讲了一种表示法</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">-&gt;</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">作为替代。即</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">rp-&gt;width</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">等价于表达式（</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">*rp&gt; .width</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">。例如，我们可以写一个</span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">1</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">¾</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">数，将一个长方形向顺时 针旋转</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">90</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">度：</span>
</tt>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">void rotate_left(struct rect *rp)</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">/* Exchange width and height */</span>
</tt>
 <tt class="calibre3">
<span class="calibre4">      </span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">.</span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">；.</span>
</tt>
 <tt class="calibre3">
<span class="calibre4">      </span>
</tt>
 <tt class="calibre3">
<span class="calibre4">.</span>
</tt>
 <tt class="calibre3">
<span class="calibre4">      </span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">,•</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">'</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">int t</span>
</tt>
 <tt class="calibre3">
<span class="calibre4">      </span>
</tt>
 <tt class="calibre3">
<span class="calibre4">=</span>
</tt>
 <tt class="calibre3">
<span class="calibre4">      </span>
</tt>
 <tt class="calibre3">
<span class="calibre4">rp-&gt;height;</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">rp-&gt;height = rp-&gt;width; rp-&gt;width = t;</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">•</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">/* Shift to new lower—left corner */</span>
</tt>
 <tt class="calibre3">
<span class="calibre4">      </span>
</tt>
 <tt class="calibre3">
<span class="calibre4">:</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">rp-&gt;llx -= t;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<span class="calibre12">
<b class="calibre13">
<span class="calibre4">&gt;</span>
</b>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<span class="calibre12">
<b class="calibre13">
<span class="calibre4">C++</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">和</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">Java</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">的对象比</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">C</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">语言中的结构要复杂精细得多，因为它们将一组可以被调用来执行 计算的方法与一个对象联系起来。在</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">C</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">语言中，我们可以简单地把这些方法</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">.</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">写成普通函数，就 像上面所示的函数</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">area</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">和</span>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">rotate—left</span>
</b>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">。</span>
</tt>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">让我们来看看这样一个例子</span>
</tt>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">，</span>
</b>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">考虑下面的结构声明</span>
</tt>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">：</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="-18pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">struct rec { int i; int j; int a [3]; int *p；</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">&gt;；</span>
</b>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">'</span>
</b>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">这个结构包括4个字段</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">——2</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">个4字节int、</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">1</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">个由3个4字节int组成的数组和</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">1</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">个4字节的 整型指针，总共是24个字节</span>
</tt>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">：</span>
</b>
</tt>
</span>
</p>
<table valign="top" class="calibre19">
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">0</span>
</tt>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">4</span>
</tt>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">8</span>
</tt>
</p>
</td>
<td class="calibre21"><br class="calibre9"/>
<br class="calibre9"/>
</td>
<td class="calibre21"><br class="calibre9"/>
<br class="calibre9"/>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">20</span>
</tt>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">i</span>
</tt>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">J</span>
</tt>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">a[0]</span>
</tt>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">a[l]</span>
</tt>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">a [2]</span>
</tt>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">P</span>
</tt>
</p>
</td>
</tr>
</table>
<p class="calibre9" style="margin:0pt; border:0pt; height:1em"> </p>
<p class="calibre9" style="margin:0pt; border:0pt; height:1em"> </p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">可以观察到，数组a是嵌入到这个结构中的。上图中顶部的数字给出的是各个字段相对于结构 开始处的字节偏移。</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">为了访问结构的字段，编译器产生的代码要将结构的地址加上适当的偏移。例如，假设 struct rec*类型的变量r放在寄存器％edx中。然后，下面的代码将元素r-；&gt;i复制到元素</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">movl</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">(°/<sub class="calibre24">
<small class="calibre8">
<span class="calibre18">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">0</span>
</b>
</tt>
</span>
</small>
</sub>
 edx), %eax</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">Get r-&gt;i</span>
</b>
</i>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">movl</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">%eax, 4(%edx)</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">Store in r-&gt;j.</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">,.</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">.,.-</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">因为字段i的偏移量为</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">0</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">,所以这个字段的地址就是r的值。为了存储到字段j</span>
</tt>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">,</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">；代码要将r的 地址加上偏移量4。</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">要产生一个指向结构内部对象的指针，我们只需将结构的地址加上该字段的偏移量。例如， 只要加上偏移量</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">8</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">+ 4 X 1 = 12,就可以得到指针&amp; (r-&gt;a [</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">1</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">])</span>
</tt>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">。</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">对于在寄存器%edx中的指针 r和在寄存器%eax中的整数变量i,</span>
</tt>
 <tt class="calibre3">
<i class="calibre15">
<span class="calibre4">'</span>
</i>
</tt>
 <tt class="calibre3">
<span class="calibre4">我们可以用一条指令产生指针&amp; (r-&gt;a [i])的值：</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">Registei's; r in</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">%edx, i</span>
</b>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">in</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">%eax 1 • leal</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">8(%edx,%eax,4) ,</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">%eax</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">Set</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">%eax to</span>
</b>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">&amp;r-&gt;a[i]</span>
</b>
</i>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">• . . .... . . ■ - •</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">最后举一个例子，下面的代码实现的是语句：</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">• ； ：</span>
</b>
</tt>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">r-&gt;p = &amp;r-&gt;a[r-&gt;i + r-&gt;j];</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">开始时r在寄存器％edx中：</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">movl</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">4(%edx), %eax</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">Get r~&gt;j</span>
</b>
</i>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">addl</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">(%edx), %eax</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">Add r~&gt;i</span>
</b>
</i>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">i</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">leal</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">8 (%edx, %eax, 4) ,</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">%eax</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">Compute &amp;r-&gt;a[r-&gt;i</span>
</b>
</i>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</i>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">+ r-&gt;j]</span>
</b>
</i>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">movl</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">°/<sub class="calibre24">
<small class="calibre8">
<span class="calibre18">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">0</span>
</b>
</tt>
</span>
</small>
</sub>
 eax, 20(%edx)</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">Store in r~&gt;p</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">.<sup class="calibre23">
<small class="calibre8">
<span class="calibre18">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">;</span>
</b>
</tt>
</span>
</small>
</sup>
</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">综上所述，结构的各个字段的选取完全是在编译时处理的。机器代码不包含于字段声明或 字段名字的信息。</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">_练习题3.39考虑下面的结构声明：</span>
</tt>
 <tt class="calibre3">
<span class="calibre4">      <sup class="calibre7">
<small class="calibre8">
<tt class="calibre3">
<span class="calibre4">：</span>
</tt>
</small>
</sup>
</span>
</tt>
 <tt class="calibre3">
<span class="calibre4">一</span>
</tt>
 <i class="calibre15">
<b class="calibre13">
<span class="calibre4">•</span>
</b>
</i>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">struct prob {</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">int *p;</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">…</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">struct {</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      <sup class="calibre23">
<small class="calibre8">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">#</span>
</b>
</tt>
</small>
</sup>
</span>
</b>
</tt>
</span>
 <tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">'</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">-•int x; int y;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">} s;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">struct prob *next;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">&gt;；</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">这个声明说明一个结构可以嵌套在另一个结构中，就像数组可以嵌套在结构中、数组可以嵌套在数组 中一样。</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">下面的过程（省略了某些表达式）对这个结构进行操作：</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">void sp_init(struct prob *sp)</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">.</span>
</b>
</tt>
 <tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">sp-&gt;s.x</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">.=</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">sp-&gt;p ’ =<sup class="calibre7">
<small class="calibre8">
<tt class="calibre3">
<span class="calibre4">5</span>
</tt>
</small>
</sup>
</span>
</tt>
 <tt class="calibre3">
<i class="calibre15">
<span class="calibre4">'——一</span>
</i>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">；</span>
</tt>
 <tt class="calibre3">
<span class="calibre4">      </span>
</tt>
 <tt class="calibre3">
<span class="calibre4">.</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">.</span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">.：,</span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">..</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">.</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">.:</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">sp-&gt;next =</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">—</span>
</b>
</tt>
</span>
 <tt class="calibre3">
<b class="calibre13">
<span class="calibre4">            </span>
</b>
</tt>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">;</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">-.、</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">下列字段的偏移量是多少（以字节为单位）？</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre2">
<b class="calibre13">
<span class="calibre4">P:</span>
</b>
</span>
 <span class="calibre2">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">next</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">这个结构总共需要多少字节?</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">编译器为sp_init的主体产生的汇编代码如下：</span>
</b>
</tt>
</span>
</p>
<table valign="top" class="calibre19">
<tr valign="top" class="calibre20">
<td colspan="2" class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">sp at</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">%ebp+S</span>
</tt>
</span>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">1 movl</span>
</b>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">8(%ebp), %eax</span>
</b>
</tt>
</span>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">2</span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">movl</span>
</b>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">8(%eax), %edx</span>
</b>
</tt>
</span>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">3</span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">movl</span>
</b>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">%edx, 4(%eax)</span>
</b>
</tt>
</span>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">A</span>
</b>
</i>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">leal</span>
</b>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">4(%eax), %edx</span>
</b>
</tt>
</span>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">5 movl</span>
</b>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">%edx, (%eax)</span>
</b>
</tt>
</span>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">6</span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">movl</span>
</b>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">%eax, 12(%eax)</span>
</b>
</tt>
</span>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">根据这些信息，</span>
</b>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">填写sp_init代码中缺失的表达式。</span>
</b>
</tt>
</span>
</p>
</td>
</tr>
</table>
<p height="0pt" width="0pt" class="calibre1">
<b class="calibre13">
<span class="calibre4">3.9.2</span>
</b>
 <tt class="calibre3">
<b class="calibre13">
<span class="calibre4">联合</span>
</b>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">联合提供了一种方式，能够规避C语言的类型系统，允许以多种类型来引用一个对象。联 合声明的语法与结构的语法一样，只不过语义相差比较大。它们是用不同的字段来引用相同的存 储器块。</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">考虑下面的声明：</span>
</tt>
</p>
<p height="0pt" width="-18pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">struct S3 { char c; int i [2]; double v;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="-18pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">union U3 { char c; int i [2]; double v;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">在一台IA32 Linux机器上编译时，字段的偏移量、数据类型S3和U3的完整大小如下：</span>
</tt>
</p>
<table valign="top" class="calibre19">
<tr valign="top" class="calibre20">
<td class="calibre21">
<blockquote height="0pt" width="0pt" class="calibre22">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">类型</span>
</b>
</tt>
</span>
</blockquote>
</td>
<td colspan="2" class="calibre21">
<blockquote height="0pt" width="0pt" class="calibre22">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">civ</span>
</b>
</tt>
</span>
</blockquote>
</td>
<td class="calibre21">
<blockquote height="0pt" width="0pt" class="calibre22">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">大小</span>
</b>
</tt>
</span>
</blockquote>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<blockquote height="0pt" width="0pt" class="calibre22">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">S3</span>
</b>
</tt>
</span>
</blockquote>
</td>
<td class="calibre21">
<blockquote height="0pt" width="0pt" class="calibre22">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">0 4</span>
</b>
</tt>
</span>
</blockquote>
</td>
<td class="calibre21">
<blockquote height="0pt" width="0pt" class="calibre22">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">12</span>
</b>
</tt>
</span>
</blockquote>
</td>
<td class="calibre21">
<blockquote height="0pt" width="0pt" class="calibre22">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">20</span>
</b>
</tt>
</span>
</blockquote>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<blockquote height="0pt" width="0pt" class="calibre22">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">U3</span>
</b>
</tt>
</span>
</blockquote>
</td>
<td class="calibre21">
<blockquote height="0pt" width="0pt" class="calibre22">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">0 0</span>
</b>
</tt>
</span>
</blockquote>
</td>
<td class="calibre21">
<blockquote height="0pt" width="0pt" class="calibre22">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">0</span>
</b>
</tt>
</span>
</blockquote>
</td>
<td class="calibre21">
<blockquote height="0pt" width="0pt" class="calibre22">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">8</span>
</b>
</tt>
</span>
</blockquote>
</td>
</tr>
</table>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">(稍后会解释S<sup class="calibre7">
<small class="calibre8">
<span class="calibre30">
<tt class="calibre3">
<span class="calibre4">3</span>
</tt>
</span>
</small>
</sup>
 中i的偏移量为什么为<sup class="calibre7">
<small class="calibre8">
<span class="calibre30">
<tt class="calibre3">
<span class="calibre4">4</span>
</tt>
</span>
</small>
</sup>
 而不是</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">1</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">,而且我们还会讨论对于一台运行Microsoft Windows的机器为什么结果会不同。）对于类型union U3*的指针p, p-&gt;c、p-&gt;i [</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">0</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">]和p-&gt;v 引用的都是数据结构的起始位置。还可以观察到，一个联合的总的大小等于它最大字段的大小。</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">在一些下上文中，联合十分有用。但是，它也引起一些讨厌的错误，因为它们绕过了 C语 言类型系统提供的安全措施。一种应用情况是，我们事先知道对一个数据结构中的两个不同字段 的使用是互斥的，那么将这两个字段声明为联合的一部分，而不是结构的一部分，以减小分配空 间的总量。</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">例如，假设我们想实现一个二叉树的数据结构，每个叶子节点都有一个double类型的数 据值，而每个内部节点都有指向两个孩子节点的指针，但是没有数据。如果声明如下：.</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">struct NODE_S {</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">struct NODE_S *left; struct NODE_S *right; double data;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">那么每个节点需要16个字节，每种类型的节点都要浪费一半的字节。如果我们声明一个节点如下:</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">union N0DE.U { struct {</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">union N0DE_U *left; union N0DE_U *right;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">} internal; double data;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">那么，每个节点就只需要</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">8</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">个字节。如果<sub class="calibre17">
<small class="calibre8">
<tt class="calibre3">
<span class="calibre4">n</span>
</tt>
</small>
</sub>
 是一个指针，指向union NODE *类型的节点，我 们用n-&gt;data来引用叶子节点的数据，而用r)-&gt;interna：!*</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">•</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">left和n-&gt;internal</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">•</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">right 来引用内部节点的孩子。</span>
</tt>
 <tt class="calibre3">
<span class="calibre4">      </span>
</tt>
 <span class="calibre25">
<tt class="calibre3">
<i class="calibre15">
<span class="calibre4">'</span>
</i>
</tt>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">然而，如果这样编码</span>
</tt>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">，</span>
</b>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">就没有办法确定一个给定的节点到底是叶子节点</span>
</tt>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">，</span>
</b>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">还是内部节点。常 用的方法是引入一个枚举类型，定义这个联合中可能的不同选择，然后再创建一个结构</span>
</tt>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">，</span>
</b>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">包含一 个标签字段和这个联合：</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">typedef enum { N_LEAF, N_INTERNAL &gt; nodetype_t;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">struct NODE_T {</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">nodetype_t type; union</span>
</b>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">i</span>
</b>
</i>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">struct {</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">struct N0DE_T *left; struct N0DE_T *right;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">internal; double data;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">info;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">&gt;； -</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">这个结构总共需要</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">12</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">个字节：type是4个字节，info</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">•</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">internal</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">.</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">left和info</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">.</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">internal</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">.</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">right各要4个字节</span>
</tt>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">，</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">或者是info .data要</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">8</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">个字节。在这种情况下，相对于给代码造成的麻 烦，使用联合带来的节省是很小的。对于有较多字段的数据结构，这样的节省会更加吸引人。 联食还可以用来访问不同数据类型的位模式。例如，下面这段代码返回的是float作为</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<span class="calibre2">
<tt class="calibre3">
<span class="calibre4">..</span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">,</span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">.■</span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">_</span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">■</span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">'</span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">      <sup class="calibre31">
<small class="calibre8">
<span class="calibre30">
<tt class="calibre3">
<span class="calibre4">1</span>
</tt>
</span>
</small>
</sup>
       </span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">.</span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">I</span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">.</span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">.</span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">.</span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">.</span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">■ ■</span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">''*■,：</span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">      </span>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">■</span>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">unsigned的位表示：</span>
</tt>
 <tt class="calibre3">
<span class="calibre4">      </span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">.、•</span>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre2">
<tt class="calibre3">
<span class="calibre4">' • ' . * . . . ' • ^ .'</span>
</tt>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">I unsigned fXoat2bit(float f)</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1"><img src="../images/00038.jpeg" class="calibre5"/>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">union</span>
</b>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">{</span>
</b>
</i>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">.float f;</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">•：</span>
</b>
</i>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</i>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">：.</span>
</b>
</i>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</i>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">:.</span>
</b>
</i>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">unsigned u;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">temp; temp</span>
</b>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">.</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">f = f;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">return temp</span>
</b>
</tt>
</span>
 <span class="calibre2">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">.</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">u;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<span class="calibre2">
<tt class="calibre3">
<span class="calibre4">• ... ‘ ...</span>
</tt>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<span class="calibre2">
<tt class="calibre3">
<span class="calibre4">* . - - - . • ' . ' . <sup class="calibre31">
<small class="calibre8">
<span class="calibre30">
<tt class="calibre3">
<span class="calibre4">1</span>
</tt>
</span>
</small>
</sup>
 ■</span>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">在这段代码中</span>
</tt>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">,</span>
</b>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">我们以一种数搪类型来存储联合中的参数</span>
</tt>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">，</span>
</b>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">又以另一种数据类齒来访问它。有趣</span>
</tt>
</p>
<p height="0pt" width="-18pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">的是，为此过程产生的代码与为下面这个过程产生的代码是一样的：</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">unsigned copy(unsigned u)</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">{</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">return u;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">}</span>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">这两个过程的主体只有一条指令：</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">movl 8(%ebp),%eax</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">这就证明机器代码中缺乏类型信息。无论参数是一个float,还是一个unsigned,它都在 相对％ebp偏移量为</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">8</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">的地方。过程只是简单地将它的参数复制到返回值</span>
</tt>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">，</span>
</b>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">不修改任何位。</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">当用联合将各种不同大小的数据类型结合到一起时，字节顺序问题就变得很重要了。例 如，假设我们写了一个过程，它以两个4字节的unsigned的位的形式，创建一个</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">8</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">字节的 double ：</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">double bit2double(unsigned wordO, unsigned wordl)</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">{</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">union {</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">double d;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">unsigned u[2];</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">} temp;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<span class="calibre4">7</span>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">temp.u[0]</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">= wordO;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">temp.u[l]</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">= wordl;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">return temp.d;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">&gt;</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">在IA32这样的小端法机器上</span>
</tt>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">，</span>
</b>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">参数wordO是d的低位4个字节</span>
</tt>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">，</span>
</b>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">而wordl是高位4个字 节。在大端法机器上，这两个参数的角色刚好相反。</span>
</tt>
</p>
<p height="0pt" width="-18pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">®练习题3.40假设给你个任务，检查一下C编译器为结构和联合的访问产生正确的代码。你写了下面 的结构声明：</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">typedef union { struct {</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">short v; short d; int s;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">tl; struct {</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">int a [2]; char *p;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">t2;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">u_type;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">你写了一组具有下面这种形式的函数</span>
</tt>
 <tt class="calibre3">
<span class="calibre4">      </span>
</tt>
 <tt class="calibre3">
<span class="calibre4">' '</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">void get(u_type *up, TYPE *dest) {</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">*dest = EXPR;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">.&gt; . -</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">•这组函数有不一样的访问表达式EXPR，而且根据EXPR•的类型来设置目的数据类型TYPE。然后再检 查编译这些函数时产生的代码，看看它们是否与你预期的一样。</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">假设在这些函数中,up和dest分别被加载到寄存器％eax和％edx中.。填写下表中的数据类型TYPE,</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre28">
<tt class="calibre3">
<span class="calibre4">并用1〜3条指令序列来计算表达式，将结果存储到dest中。斌着只用寄存器％eax和％edx,不够用的 时候，再用寄存器％ecx。</span>
</tt>
</p>
<table valign="top" class="calibre19">
<tr valign="top" class="calibre20">
<td class="calibre21">
<blockquote height="0pt" width="0pt" class="calibre22">
<tt class="calibre3">
<span class="calibre4">EXPR</span>
</tt>
</blockquote>
</td>
<td class="calibre21">
<blockquote height="0pt" width="0pt" class="calibre22">
<tt class="calibre3">
<span class="calibre4">TYPE</span>
</tt>
</blockquote>
</td>
<td class="calibre21">
<blockquote height="0pt" width="0pt" class="calibre22">
<tt class="calibre3">
<span class="calibre4">Code</span>
</tt>
</blockquote>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<blockquote height="0pt" width="0pt" class="calibre22">
<tt class="calibre3">
<span class="calibre4">up-&gt;tl.S</span>
</tt>
</blockquote>
</td>
<td class="calibre21">
<blockquote height="0pt" width="0pt" class="calibre22">
<tt class="calibre3">
<span class="calibre4">int</span>
</tt>
</blockquote>
</td>
<td class="calibre21">
<blockquote height="0pt" width="0pt" class="calibre22">
<tt class="calibre3">
<span class="calibre4">movl 4(%eax) , %eax movl %eax, (°/<sub class="calibre17">
<small class="calibre8">
<tt class="calibre3">
<span class="calibre4">0</span>
</tt>
</small>
</sub>
 edx)</span>
</tt>
</blockquote>
</td>
</tr>
<tr valign="top" class="calibre20">
<td rowspan="3" class="calibre21">
<blockquote height="0pt" width="0pt" class="calibre22">
<tt class="calibre3">
<span class="calibre4">up-&gt;tl.</span>
</tt>
 <span class="calibre2">
<b class="calibre13">
<span class="calibre4">V</span>
</b>
</span>
 <tt class="calibre3">
<span class="calibre4">&amp;up-&gt;tl.d</span>
</tt>
</blockquote>
</td>
<td class="calibre21"><br class="calibre9"/>
<br class="calibre9"/>
</td>
<td class="calibre21"><br class="calibre9"/>
<br class="calibre9"/>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21"><br class="calibre9"/>
<br class="calibre9"/>
</td>
<td class="calibre21">
<blockquote height="0pt" width="3em" class="calibre22">
<tt class="calibre3">
<span class="calibre4">                  </span>
</tt>
</blockquote>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21"><br class="calibre9"/>
<br class="calibre9"/>
</td>
<td class="calibre21"><br class="calibre9"/>
<br class="calibre9"/>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<blockquote height="0pt" width="0pt" class="calibre22">
<tt class="calibre3">
<span class="calibre4">up-&gt;t2. a</span>
</tt>
</blockquote>
</td>
<td class="calibre21"/>
<td class="calibre21"><br class="calibre9"/>
<br class="calibre9"/>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<blockquote height="0pt" width="0pt" class="calibre22">
<tt class="calibre3">
<span class="calibre4">up-&gt;t2. a[up-&gt;tl.s]</span>
</tt>
</blockquote>
</td>
<td class="calibre21"/>
<td class="calibre21"><br class="calibre9"/>
<br class="calibre9"/>
</td>
</tr>
<tr valign="top" class="calibre20">
<td rowspan="2" class="calibre21">
<blockquote height="0pt" width="0pt" class="calibre22">
<tt class="calibre3">
<span class="calibre4">*up-&gt;t2.p</span>
</tt>
</blockquote>
</td>
<td class="calibre21"><br class="calibre9"/>
<br class="calibre9"/>
</td>
<td class="calibre21"><br class="calibre9"/>
<br class="calibre9"/>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21"><br class="calibre9"/>
<br class="calibre9"/>
</td>
<td class="calibre21"><br class="calibre9"/>
<br class="calibre9"/>
</td>
</tr>
</table>
<p class="calibre9" style="margin:0pt; border:0pt; height:1em"> </p>
<p class="calibre9" style="margin:0pt; border:0pt; height:1em"> </p>
<p class="calibre9" style="margin:0pt; border:0pt; height:1em"> </p>
<p class="calibre9" style="margin:0pt; border:0pt; height:1em"> </p>
<p class="calibre9" style="margin:0pt; border:0pt; height:1em"> </p>
<p class="calibre9" style="margin:0pt; border:0pt; height:1em"> </p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">数据对齐</span>
</b>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">许多计算机系统对基本数据类型合法地址做出了一些限制，要求某种类型对象的地址必须是 某个值尺（通常是</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">2</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">、4或</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">8</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">)的倍数。这种对齐限制简化了形成处理器和存储器系统之间接口 的硬件设计。例如，假设一个处理器总是从存储器中取出</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">8</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">个字节，则地址必须为</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">8</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">的倍数。如 果我们能保证将所有的double类型数据的地址对齐成</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">8</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">的倍数，那么就可以用一个存储器操 作来读或者写值了。否则，我们可能需要执行两次存储器访问，因为对象可能被分放在两个</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">8</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">字 节存储器块中。</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">无论数据是否对齐，IA32硬件都能正确工作。不过，Intel还是建议要对齐数据以提高存储 器系统的性能。Linux沿用的对齐策略是，</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">2</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">字节数据类型（例如short)的地址必须是</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">2</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">的倍 数，而较大的数据类型（例如int、int*、float和double)的地址必须是4的倍数。注意， 这个要求就意味着一个short类型对象的地址最低位必须等于</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">0</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">。类似地，任何int类型的对 象或指针的地址的最低两位必须都是</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">0</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">。</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">强制对齐的情况</span>
</b>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">对于大多数IA32指令来说，保持数据对齐能够提高效率，但是它不会影响程序的行为。另 一方面，如果数据未对齐，有些实现多媒体操作的SSE指令就无法正确地工作。这些指令对16 字节数据块进行操作，在SSE单元和存储器之间传送数据的指令要求存储器地址必须是16的倍 数。任何试图以不满足对齐要求的地址来访问存储器都会导致异常（exception),默认的行为是 程序终止。</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">因此IA32的一个惯例是，确保每个栈帧的长度都是16字节的整数倍。编译器就可以在栈 帧中以每个块的存储都是16字节对齐的方式来分配存储。</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<b class="calibre13">
<span class="calibre4">Microsoft Windows</span>
</b>
 <tt class="calibre3">
<b class="calibre13">
<span class="calibre4">的对齐</span>
</b>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">Microsoft Windows对齐的要求更严格</span>
</tt>
 <tt class="calibre3">
<span class="calibre4">      </span>
</tt>
 <tt class="calibre3">
<span class="calibre4">任何尺字节基本对象的地址都必须是[的倍数,</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<i class="calibre15">
<span class="calibre4">K=2,</span>
</i>
</tt>
 <tt class="calibre3">
<span class="calibre4">4或者</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">8</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">。特别地，它要求一个double或者long long类型数据的地址应该是</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">8</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">的倍 数。这种要求提高了存储器性能，而代价是浪费了一些空间。Linux的惯例是</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">8</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">字节数据在4字 节边界上对齐，这可能对i386很好，因为过去存储器十分缺乏，而存储器接口只有4字节宽。 对于现代处理器来说，Microsoft的对齐策略就是更好的选择。在Windows和Linux上，数据类 型long double都有4字节对齐的要求，为此GCC产生的IA32代码分配12个字节（虽然实 际的数据类型只需要</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">10</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">个字节）。</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">确保每种数据类型都按照指定方式来组织和分配，即每种类型的对象都满足它的对齐限制， 就可保证实施对齐。编译器在汇编代码中放入命令，指明全局数据所需的对齐。例如，3、</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">6</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">、7 节中的跳转表，汇编代码声明的第</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">2</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">行包含下面这样的命令：</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<span class="calibre2">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">.</span>
</b>
</tt>
</span>
 <span class="calibre12">
<b class="calibre13">
<span class="calibre4">align 4</span>
</b>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">这就保证了它后面的数据（在此，是跳转表的开始）的起始地址是4的倍数。因为每个表项 长4个字节</span>
</tt>
 <span class="calibre12">
<tt class="calibre3">
<span class="calibre4">，</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">后面的元素都会遵守4字节对齐的限制。</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">分配存储器的库例程（例如malloc)的设计必须使它们返回的指针满足运行机器最糟糕情 况的对齐限制，通常是4或者</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">8</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">。对于包含结构的代码，编译器可能需要在字段的分配中插入间 隙，以保证每个结构元素都满足它的对齐要求。而结构本身对它的起始地址也有一些对齐要求。</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">比如说，考虑下面的结构声明：</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre28">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">struct S1 { int i; char c;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1"><img src="../images/00039.jpeg" class="calibre5"/>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">假设编译器用最小的9字节分配，画出图来是这样的：</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">偏移j</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">45</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">9</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">内容丨 i 丨。| J</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">它不可能满足字段i (偏移为</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">0</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">)和j (偏移为5)的4字节对齐要求。编译器在字段c和j之 间插入一个3字节的间隙（用阴影表示)，改后的图如下：</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">偏移 j</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">45</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">8</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">12</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">内容 i</span>
</tt>
 <tt class="calibre3">
<span class="calibre4">
<span class="calibre14">土</span>
</span>
</tt>
 <tt class="calibre3">
<span class="calibre4">      </span>
</tt>
 <tt class="calibre3">
<span class="calibre4">j</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">结果，j的偏移量为</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">8</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">,而整个结构的大小为</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">12</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">字节。此外，编译器必须保证任何struct S1*类型的指针p都满足4字节对齐。用我们前面的符号，让指针p的值为;c<sub class="calibre17">
<small class="calibre8">
<tt class="calibre3">
<span class="calibre4">p</span>
</tt>
</small>
</sub>
 。那么，x<sub class="calibre17">
<small class="calibre8">
<tt class="calibre3">
<span class="calibre4">p</span>
</tt>
</small>
</sub>
 必须 是4的倍数。这就保证了 p-&gt;i (地址x<sub class="calibre17">
<small class="calibre8">
<tt class="calibre3">
<span class="calibre4">p</span>
</tt>
</small>
</sub>
 )和p-&gt;j (地址jc<sub class="calibre17">
<small class="calibre8">
<tt class="calibre3">
<span class="calibre4">p</span>
</tt>
</small>
</sub>
 +</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">8</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">)都满足它们的4字节对齐要求。</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<tt class="calibre3">
<span class="calibre4">另外，编译器结构的末尾可能需要一些填充，这¥结构数组中的每个元素都会满足它的对齐 要求。例如，考虑下面这个结构声明：</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">struct S2</span>
</b>
</tt>
</span>
 <span class="calibre12">
<i class="calibre15">
<b class="calibre13">
<span class="calibre4">i</span>
</b>
</i>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">char c;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">如果我们将这个结构打包成9个字节，只要保证结构的起始地址满足4字节对齐要求，我们仍然 能够保证满足字段i和j的对齐要求。不过，考虑下面的声明••</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<span class="calibre12">
<b class="calibre13">
<span class="calibre4">struct S2 d[4];</span>
</b>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">分配9个字节，不可能满足d的每个元素的对齐要求，因为这些元素的地址分别为x<sub class="calibre17">
<small class="calibre8">
<tt class="calibre3">
<span class="calibre4">d</span>
</tt>
</small>
</sub>
 、x<sub class="calibre17">
<small class="calibre8">
<tt class="calibre3">
<span class="calibre4">d</span>
</tt>
</small>
</sub>
 + 9、 jc<sub class="calibre17">
<small class="calibre8">
<tt class="calibre3">
<span class="calibre4">d</span>
</tt>
</small>
</sub>
 + 18和:c<sub class="calibre17">
<small class="calibre8">
<tt class="calibre3">
<span class="calibre4">d</span>
</tt>
</small>
</sub>
 + 27。相反地，编译器会为结构S2分配12个字节，最后3个字节是浪费的空间：</span>
</tt>
</p>
<p height="0pt" width="2em" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">偏移0</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">4</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">8</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">9</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">12</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1"><img src="../images/00040.jpeg" class="calibre5"/>
</p>
<p height="0pt" width="0pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">这样一来，d的元素的地址分别为;c<sub class="calibre17">
<small class="calibre8">
<tt class="calibre3">
<span class="calibre4">d</span>
</tt>
</small>
</sub>
 、x<sub class="calibre17">
<small class="calibre8">
<tt class="calibre3">
<span class="calibre4">d</span>
</tt>
</small>
</sub>
 +</span>
</tt>
 <span class="calibre2">
<tt class="calibre3">
<span class="calibre4">12</span>
</tt>
</span>
 <tt class="calibre3">
<span class="calibre4">、〜+ 24和〜+ 36。只要;^是4的倍数，所有的 对齐限制就都可以满足了。</span>
</tt>
</p>
<p height="0pt" width="-18pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">_练习题3.41对下面每个结构声明，确定每个字段的偏移量、结构总的大小，以及在Linux/IA32下它 的对齐要求。</span>
</tt>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">struct</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">PI</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">{</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">int i; char c; int j; char d; };</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">struct</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">P2</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">{</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">int i; char c; char d; int j ;</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">，</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">struct</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">P3</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">{</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">short w[3] ; char c[3] &gt;;</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">struct</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">P4</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">{</span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">      </span>
</b>
</tt>
</span>
 <span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">short w[3] ; char *c[3]</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">struct P3 { struct PI a [2] ; struct P2 *p };</span>
</b>
</tt>
</span>
</p>
<p height="0pt" width="-18pt" class="calibre1">
<tt class="calibre3">
<span class="calibre4">®练习题3.42对于结构声明</span>
</tt>
</p>
<table valign="top" class="calibre19">
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">struct {</span>
</b>
</tt>
</span>
</p>
</td>
<td class="calibre21"><br class="calibre9"/>
<br class="calibre9"/>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">char &gt;</span>
</b>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">Ka</span>
</b>
</tt>
</span>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">short</span>
</b>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">b</span>
</b>
</tt>
</span>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">double</span>
</b>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">c</span>
</b>
</tt>
</span>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">char</span>
</b>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">d</span>
</b>
</tt>
</span>
</p>
</td>
</tr>
<tr valign="top" class="calibre20">
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">float</span>
</b>
</tt>
</span>
</p>
</td>
<td class="calibre21">
<p height="0pt" width="0pt" class="calibre1">
<span class="calibre12">
<tt class="calibre3">
<b class="calibre13">
<span class="calibre4">e</span>
</b>
</tt>
</span>
</p>
</td>
</tr>
</table>
</body>
</html>
